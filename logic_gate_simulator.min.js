var script=document.createElement("script");script.src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js";script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);
function Queue(){var k=[],d=0;this.getLength=function(){return k.length-d};this.isEmpty=function(){return 0==k.length};this.enqueue=function(d){k.push(d)};this.dequeue=function(){if(0!=k.length){var l=k[d];2*++d>=k.length&&(k=k.slice(d),d=0);return l}};this.peek=function(){return 0<k.length?k[d]:void 0}}
function logic_container(k){var d=$("#"+k);this.svg_element=d;this.gates={};this.gate_queue=new Queue;this.run_next=function(c){var a=c.gate_queue.dequeue();if("undefined"!=typeof a)if("switch"==a.type)for(var b=0;b<a.outputs[0].connections.length;b++)c.gate_queue.enqueue(a.outputs[0].connections[b].input.gate);else{for(var f=[],b=0;b<a.inputs.length;b++)f.push("true"==a.inputs[b].state);for(b=0;b<a.outputs.length;b++)for(var e=a.outputs[b].logic(f),h=0;h<a.outputs[b].connections.length;h++){var d=
a.outputs[b].connections[h];d.set(e);var g=d.input.gate;"led"==g.type?g.set_state(e):c.gate_queue.enqueue(d.input.gate)}}};this.run_forever=function(c){var a=this.run_next,b=this;setInterval(function(){a(b)},c)};this.switch_callback=function(c){for(var a=0;a<c.output.connections.length;a++)c.output.connections[a].toggle(),this.gate_queue.enqueue(c.output.connections[a].input.gate)};this.refresh_html=function(){this.svg_element.html(this.svg_element.html());var c=this;$(".togglable."+k).on("click",
function(a){id=c.svg_element.find("#"+this.id).parent().attr("id");s=c.gates[id];s.toggle();c.switch_callback(s)})};this.add_and=function(c,a,b,f,e){a=new this.and_gate(c,a,b,f,e);this.gates[c]=a;this.svg_element.append(a.$gate);this.refresh_html();return a};this.add_or=function(c,a,b,f,e,h){a=new this.or_gate(c,a,b,f,e,h);this.gates[c]=a;this.svg_element.append(a.$gate);this.refresh_html();return a};this.add_buffer=function(c,a,b,f){a=new this.buffer(c,a,b,f);this.gates[c]=a;this.svg_element.append(a.$gate);
this.refresh_html();return a};this.add_toggle_switch=function(c,a,b){a=new this.toggle_switch(c,a,b);this.gates[c]=a;this.svg_element.append(a.$gate);this.gate_queue.enqueue(a);this.refresh_html();return a};this.add_led=function(c,a,b){a=new this.led(c,a,b);this.gates[c]=a;this.svg_element.append(a.$gate);this.refresh_html();return a};this.add_custom=function(c,a,b,f,e,h,d){a=new this.customizable_gate(c,a,b,f,e,h,d);this.gates[c]=a;this.svg_element.append(a.$gate);this.refresh_html();return a};var l=
function(){if(""!=this.id){var c=d.find("#"+this.id);"true"==c.attr("state")?c.attr({state:"false",stroke:"black"}):c.attr({state:"true",stroke:"red"});"true"==this.state?this.state="false":this.state="true"}},m=function(c){""!=this.id&&(c=c.toString(),d.find("#"+this.id).attr({state:c,stroke:"true"==c?"red":"black"}),this.state=c)};this.and_gate=function(c,a,b,f,e){this.num_inputs=e||2;this.width=25;this.height=20*this.num_inputs;this.type="and";this.inv=f=f||!1;this.id=c;this.inputs=[];for(e=0;e<
this.num_inputs;e++){var h=b+(e+1)/(this.num_inputs+1)*this.height;this.inputs.push({id:c+"_input"+e.toString(),x1:a-15,x2:a-1,y1:h,y2:h,state:"false",stroke:"black",x:a-15,y:h,toggle:l,set:m,connection:null,gate:this})}this.outputs=[];this.output={id:c+"_output",x1:a+this.width+this.height/2+1,x2:a+this.width+this.height/2+15,y1:b+this.height/2,y2:b+this.height/2,state:"false",stroke:"black",x:a+this.width+this.height/2+15,y:b+this.height/2,toggle:l,set:m,connections:[],gate:this};this.output.logic=
function(a){for(var b=0;b<a.length;b++)if(!a[b])return f;return!f};this.outputs.push(this.output);this.$gate=$("<g></g>").attr({id:c}).append($("<path></path>").addClass("gate").attr({d:"M "+a.toString()+" "+b.toString()+" l "+this.width+" 0 a "+(10*this.num_inputs).toString()+" "+(10*this.num_inputs).toString()+" 0 1 1 0 "+this.height.toString()+" l "+(-this.width).toString()+" 0 l 0 "+(-this.height).toString()})).append($("<line></line>").attr(this.output));for(e=0;e<this.num_inputs;e++)this.$gate.append($("<line></line>").attr(this.inputs[e]));
this.inv&&(this.$gate.append($("<circle></circle>").addClass("gate").attr({cx:a+this.width+this.height/2+4,cy:b+this.height/2,r:4})),output=this.$gate.find("#"+c+"_output"),output.attr({x1:a+this.width+this.height/2+9,y1:b+this.height/2,x2:a+this.width+this.height/2+23,y2:b+this.height/2}),this.output.x=a+this.width+this.height/2+23)};this.or_gate=function(c,a,b,f,e,h){this.num_inputs=h||2;this.inv=f=f||!1;this.type=(e=e||!1)?"xor":"or";this.num_inputs=e?2:this.num_inputs;this.x=a;this.y=b;this.width=
25;this.height=20*this.num_inputs;this.inputs=[];for(h=0;h<this.num_inputs;h++){var d=b+(h+1)/(this.num_inputs+1)*this.height;this.inputs.push({id:c+"_input"+h.toString(),x1:a-11,x2:a-1,y1:d,y2:d,state:"false",stroke:"black",x:a-11,y:d,toggle:l,set:m,connection:null,gate:this})}this.outputs=[];this.output={id:c+"_output",x1:a+this.width+this.height/2+1,x2:a+this.width+this.height/2+15,y1:b+this.height/2,y2:b+this.height/2,state:"false",stroke:"black",x:a+this.width+this.height/2+15,y:b+this.height/
2,toggle:l,set:m,connections:[],gate:this};this.output.logic=function(a){for(var b=0;b<a.length;b++)if(a[b])return!f;return f};this.outputs.push(this.output);this.$gate=$("<g></g>").attr({id:c}).append($("<path></path>").addClass("gate").attr({d:"M "+a.toString()+" "+b.toString()+" q "+(15*this.num_inputs).toString()+" "+(-this.num_inputs).toString()+" "+(this.width+this.height/2).toString()+" "+(this.height/2).toString()})).append($("<path></path>").addClass("gate").attr({d:"M "+a.toString()+" "+
(b+this.height).toString()+" q "+(15*this.num_inputs).toString()+" "+this.num_inputs.toString()+" "+(this.width+this.height/2).toString()+" "+(-this.height/2).toString()})).append($("<path></path>").addClass("gate").attr({d:"M "+a.toString()+" "+b.toString()+" q 10 "+(this.height/2).toString()+" 0 "+this.height.toString()}));e&&(this.$gate.append($("<path></path>").addClass("gate").attr({d:"M "+(a-5).toString()+" "+b.toString()+" q 10 "+(this.height/2).toString()+" 0 "+this.height.toString()})),this.outputs[0].logic=
function(a){a=1==(a[0]^a[1]);return a=this.inv?!a:a});this.$gate.append($("<line></line>").attr(this.output));for(h=0;h<this.num_inputs;h++)this.$gate.append($("<line></line>").attr(this.inputs[h]));this.inv&&(this.$gate.append($("<circle></circle>").addClass("gate").attr({cx:a+this.width+this.height/2+4,cy:b+this.height/2,r:4})),output=this.$gate.find("#"+c+"_output"),output.attr({x1:a+this.width+this.height/2+9,y1:b+this.height/2,x2:a+this.width+this.height/2+23,y2:b+this.height/2}),this.output.x=
a+this.width+this.height/2+23)};this.buffer=function(c,a,b,f){this.inv=f||!1;this.type="buffer";this.x=a;this.y=b;this.width=25;this.height=20;this.inputs=[];this.outputs=[];this.input1={id:c+"_input",x1:a-14,x2:a,y1:b+this.height/2,y2:b+this.height/2,state:"false",stroke:"black",x:a-14,y:b+this.height/2,toggle:l,set:m,connection:null,gate:this};this.output={id:c+"_output",x1:a+this.width,x2:a+this.width+14,y1:b+this.height/2,y2:b+this.height/2,state:"false",stroke:"black",x:a+this.width+14,y:b+this.height/
2,toggle:l,set:m,connections:[],gate:this};this.output.logic=function(a){a=a[0];return a=f?!a:a};this.inputs.push(this.input1);this.outputs.push(this.output);this.$gate=$("<g></g>").attr({id:c,inv:f}).append($("<path></path>").addClass("gate").attr({d:"M "+a.toString()+" "+b.toString()+" L "+(a+this.width).toString()+" "+(b+this.height/2).toString()+" "+a.toString()+" "+(b+this.height).toString()+" "+a.toString()+" "+b.toString()})).append($("<line></line>").attr(this.input1)).append($("<line></line>").attr(this.output));
f&&this.$gate.append($("<circle></circle>").addClass("gate").attr({cx:a+this.width+4,cy:b+this.height/2,r:4}))};this.toggle_switch=function(c,a,b){this.type="switch";this.output={id:c+"_input",x1:a+30,x2:a+44,y1:b+10,y2:b+10,state:"false",stroke:"black",x:a+44,y:b+10,toggle:l,set:m,connections:[],gate:this};this.outputs=[];this.outputs.push(this.output);this.$gate=$("<g></g>").attr({id:c}).append($("<path></path>").attr({d:"M "+a.toString()+" "+b.toString()+" L "+(a+20).toString()+" "+b.toString()+
" L "+(a+30).toString()+" "+(b+10).toString()+" L "+(a+20).toString()+" "+(b+20).toString()+" L "+a.toString()+" "+(b+20).toString()+" L "+a.toString()+" "+b.toString(),stroke:"#4b4",fill:"white"})).append($("<circle></circle>").addClass("togglable").addClass(k).attr({id:c+"_switch",state:"false",cx:a+13,cy:b+10,r:8,stroke:"#6b6","stroke-width":2,fill:"#ddd"})).append($("<line></line>").attr(this.output));this.toggle=function(){var a=d.find("#"+c+"_switch");"true"==a.attr("state")?a.attr({state:"false",
fill:"#ddd"}):a.attr({state:"true",fill:"red"})};this.set_state=function(a){a=a.toString();d.find("#"+c+"_switch").attr({state:a,fill:"true"==a?"red":"#ddd"})};this.get_state=function(){return"true"==d.find("#"+c+"_switch").attr("state")}};this.led=function(c,a,b){this.type="led";this.inputs=[];this.input1={id:c+"_output",x1:a-14,x2:a,y1:b+10,y2:b+10,state:"false",stroke:"black",x:a-14,y:b+10,toggle:l,set:m,connection:null,gate:this};this.inputs.push(this.input1);this.$gate=$("<g></g>").attr({id:c}).addClass("led").append($("<circle></circle>").attr({cx:a+
10,cy:b+10,r:10,"stroke-width":2,stroke:"#6b6",fill:"white"})).append($("<circle></circle>").attr({id:c+"_led",cx:a+10,cy:b+10,r:7,"stroke-width":0,stroke:"#6b6",fill:"#ddd"})).append($("<line></line>").attr(this.input1));this.toggle=function(){var a=d.find("#"+c+"_led");"true"==a.attr("state")?a.attr({state:"false",fill:"#ddd"}):a.attr({state:"true",fill:"red"})};this.set_state=function(a){a=a.toString();d.find("#"+c+"_led").attr({state:a,fill:"true"==a?"red":"#ddd"})};this.get_state=function(){return"true"==
d.find("#"+c+"_led").attr("state")}};this.customizable_gate=function(c,a,b,f,e,d,k){this.type="customizable";this.x=a;this.y=b;var g=Math.max(e,d);this.width=10+10*f.length;this.height=20*g;this.inputs=[];this.outputs=[];for(g=0;g<e;g++){var n=b+(g+1)/(e+1)*this.height;this.inputs.push({id:c+"_input"+g.toString(),x1:a-14,x2:a,y1:n,y2:n,state:"false",stroke:"black",x:a-14,y:n,toggle:l,set:m,connection:null,gate:this})}for(g=0;g<d;g++)n=b+(g+1)/(d+1)*this.height,n={id:c+"_output"+g.toString(),x1:a+
this.width,x2:a+this.width+14,y1:n,y2:n,state:"false",stroke:"black",x:a+this.width+14,y:n,toggle:l,set:m,connections:[],gate:this},n.logic=k[g],this.outputs.push(n);this.$gate=$("<g></g>").attr({id:c}).append($("<line></line>").addClass("gate").attr({x1:a,x2:a+this.width,y1:b,y2:b,stroke:"black"})).append($("<line></line>").addClass("gate").attr({x1:a+this.width,x2:a+this.width,y1:b,y2:b+this.height,stroke:"black"})).append($("<line></line>").addClass("gate").attr({x1:a+this.width,x2:a,y1:b+this.height,
y2:b+this.height,stroke:"black"})).append($("<line></line>").addClass("gate").attr({x1:a,x2:a,y1:b+this.height,y2:b,stroke:"black"})).append($("<text></text>").addClass("gate_text").attr({x:a+this.width/2,y:b+this.height/2+4,"text-anchor":"middle"}).append(f));for(g=0;g<e;g++)this.$gate.append($("<line></line>").attr(this.inputs[g]));for(g=0;g<d;g++)this.$gate.append($("<line></line>").attr(this.outputs[g]))};this.connect=function(c,a,b,d){ig=this.gates[b];og=this.gates[c];input=ig.inputs[d];output=
og.outputs[a];line={id:output.id+"_to_"+input.id,state:"false",x1:input.x,x2:output.x,y1:input.y,y2:output.y,stroke:"black",toggle:l,set:m};$line=$("<g></g>").append($("<line></line>").attr(line));this.svg_element.append($line);this.refresh_html();connection={input_gate:ig,output_gate:og,input:input,output:output,line:line,toggle:function(){this.input.toggle();this.output.toggle();this.line.toggle()},set:function(a){this.input.set(a);this.output.set(a);this.line.set(a)}};input.connection=connection;
output.connections.push(connection)}};
